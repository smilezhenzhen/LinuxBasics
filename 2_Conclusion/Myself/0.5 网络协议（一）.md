---
typora-copy-images-to: assets
---

### 1 ifconfig最熟悉的命令行

#### 1.1 查看IP地址

在windows上使用ipconfig，在linux上使用ifconfig，也可以使用ip addr；IP地址是一个网卡在网络世界的通讯地址，相当于现实世界的门牌号；IP地址的分类：

![1562206306385](D:\Git\2_Conclusion\Myself\assets\1562206306385.png)

#### 1.2 无类型域间选路(CIDR)

将 32 位的 IP 地址一分为二，前面是网络号，后面是主机号。10.100.122.2/24，这个IP地址中有一斜杠，斜杠后面有个数字24，这种地址表示形式就是CIDR。后面24的意思是，32位中前24位是网络号，后8位是主机号。伴随着CIDR存在的，一个是广播地址，10.100.122.255，若发送这个地址所有10.100.122网络里的机器都能收到；另一个是子网掩码，255.255.255.0，将子网掩码和IP地址按位计算AND，即可得到网络号10.100.122.0.

#### 1.3 公有IP地址与私有IP地址

公有IP地址由某个组织统一分配，需要购买；私有IP可理解为内网IP，可由用户自己配置。下面这个是在linux下运行ip addr的结果：

```shell
root@test:~# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff
    inet 10.100.122.2/24 brd 10.100.122.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fec7:7975/64 scope link 
       valid_lft forever preferred_lft forever
```

在IP地址后面有个scope，对于eth0这张网卡来讲，是global，说明这张网卡是可以对外的，可以接收来自各个地方的包；对于lo来讲是host，说明这张网卡仅仅可供本机相互通信。lo全称为loopback，又称环回接口，往往会被分配到127.0.0.1这个地址，改地址用于本机通信，经过内核处理后直接返回，不会再任何网络中出现。

#### 1.4 MAC地址

IP地址的上一行link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff被称作MAC地址，是一个网卡的物理地址，用十六进制的6个byte表示，且全局唯一。MAC地址更像身份证，是一个唯一的标识，无定位功能。一个网络包要从一个地方传到另一个地方，除了要有确定的地址，还需要有定位功能，即IP。

### 2 DHCP与PXE

只要是在网络上跑的包，都是完整的，可以有下层没上层，绝对不可能有上层没下层；Linux默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关；不同系统的配置文件格式不同，但是无非就是CIDR、子网掩码、广播地址和网关地址。

#### 2.1 动态主机配置协议（DHCP）

如果是数据中心里面的服务器，IP一旦配置好，基本不会变，就相当于买房自己装修。DHCP的方式就相当于租房，不用装修，但都是帮你配置好的，暂时用一下，用完退租就可以了。

#### 2.2 解析DHCP的工作方式

新来的机器只有MAC地址，没有IP，使用IP地址0.0.0.0发送了一个广播包，目的IP地址为255.255.255.255，用来寻求分配IP地址，广播包封装了UDP，UDP封装了BOOTP，该过程称为DHCP Discover。

DHCP Server知道新机器的加入，并为其分配IP地址，该过程称作DHCP Offer。在分配地址之前，DHCP Server仍采用广播的方式与新机器通信，分配IP的同时还会携带子网掩码、网关等信息。新机器会接受最先到达的那个IP地址，同时向网络发送一个DHCP Request广播数据包，包中包含客户端的MAC地址、接受租约中的IP地址，提供该IP的DHCP服务器地址，并告诉所有DHCP Server它讲接受哪一台服务器提供的IP地址。当DHCP Server接收到客户机的DHCP Request后，会广播返回给客户机一个DHCP ACK消息包，表明已经接受客户机的选择，并将这一IP地址的合法租用信息和其它的配置信息都放入改广播包，发给客户机。

#### 2.3 预启动执行环境（PXE）

PXE协议分为客户端和服务器端，由于还没有操作系统，只能先把客户端放在BIOS里，当计算机启动时，BIOS把PXE客户端调入内存里面，就可以连接到服务端做一些操作了。

#### 2.4 解析PXE的工作过程

DHCP协议能给客户推荐装修队，能够安装操作系统，这个在云计算领域大有用处。

### 3 从物理层到MAC层

#### 3.1 物理层

要想两台电脑能够通信，IP地址、子网掩码、默认网关必须配置为一个网络。集线器hub是工作在物理层的设备，其有多个接口但没有大脑，它会将收到的每一个字节都复制到其它端口上，且采用广播的方式，这样就会带来以下三个问题：

①  这个包是发给谁的，谁应该接收

②  大家都在发，会不会产生混乱，有没有谁先发，谁后发的规则

③  如果发送的时候出现了错误怎么办

#### 3.2 数据链路层

数据链路层也称MAC层（Medium Access Control），即媒体访问控制来解决上述问题。

首先第一个问题，会牵扯到第二层的网络包格式，其中包含目标MAC地址、源MAC地址、类型（IP数据包）等，通过这个目标地址在链路上广播，MAC的网卡即可发现哪个包是发给自己的；

![1562206977234](D:\Git\2_Conclusion\Myself\assets\1562206977234.png)                                                  

对于第二个问题，以车管所管束马路上跑的车为例，一般采用以下三种方式：

①    分多个车道，每车一个车道，互不干扰，在计算机网络中称作信道划分；

②    分单双号出行，轮着来，在计算机网络中称作轮流协议；

③    有事先出门，发现特堵就回去，错过高峰再出，称作随机接入协议。

对于第三个问题，采用CRC循环冗余检验，通过XOR异或的算法，来计算整个包是否在发送过程中出现了错误。

还有一个问题，当源机器知道目标机器的时候，可将目标地址放入包中，如果不知道，一个广播记网络里面接入了N台机器，如何知道每个MAC地址是谁呢。这就可以通过ARP协议，即已知IP地址，求MAC地址的协议。

因为物理层的hub采用广播通信，所以每一次通信都需要广播，造成很大的资源浪费，这时就需要一种设备能够记住每台电脑的MAC，如果目标地址不是这台电脑的，这个电脑就不用转发了，这就是二层设备交换机。即交换机具有MAC地址的学习能力，学完它就知道每台电脑的MAC地址，就不用转发。

那交换机是如何知道每台电脑的MAC地址的，如何进行学习的呢。交换机是刚开始虽然不知道目标MAC对应的电脑，但是可以通过记住源MAC地址对应的电脑，通信的次数多了，整个网络的MAC地址交换机就都知道了，整个学习的结果就是转发表。当然每个机器的IP地址会变，所有的口会变，所以这个转发表是有时效性的，需要定期不断的学习。

![1562206992552](D:\Git\2_Conclusion\Myself\assets\1562206992552.png)

#### 3.3 如果一个局域网里面有多个交换机，ARP 广播的模式会出现什么问题呢？

ARP广播时，交换机会将一个端口收到的包转发到其它所有的端口上。比如数据包经过交换机A到达交换机B，交换机B又将包复制为多份广播出去。如果整个局域网存在一个环路，使得数据包又重新回到了最开始的交换机A，这个包又会被A再次复制多份广播出去。如此循环，数据包会不停得转发，而且越来越多，最终占满带宽，或者使解析协议的硬件过载，行成广播风暴。

### 4 交换机与VLAN

当交换机数目越来越多时，会遇到环路问题，让网络包迷路，这就需要使用STP协议，通过华山论剑比武的方式，将有环路的图变成没有环路树，从而解决环路问题；

交换机数目多会面临隔离问题，可以通过VLAN形成虚拟局域网（即在数据包中增添一个tag，用于区分不同的局域网络，每个虚拟局域网使用相同的VLAN，不用的虚拟局域网使用Trunk口进行通信），从而解决广播问题和安全问题。

### 5 ICPM与ping

#### 5.1 ICMP协议的格式

ICMP的全称 Internet control message protocol，互联网控制报文协议。

#### 5.2 查询报文类型

Ping就是查询报文，是一种主动请求，并且获得主动应答的ICMP协议，对应ICMP的查询报文类型；

对ping的主动请求进行网络抓包，称为 ICMP ECHO REQUEST；同理主动请求的回复称为ICMP ECHO REPLY。

差错报文类型。

#### 5.3 差错报文的例子：

①终点不可达代码为3（网络不可达代码为0，主机不可达代码为1，协议不可达代码为2，端口不可达代码为3，需要进行分片但设置了不分片代码为4）；

②源抑制代码为4，就是让源站放慢发送速度；

③时间超时为11，就是超过网络包的生存时间还没到；

④路由重定向为5，就是下次发给另一个路由。

#### 5.4 Ping：查询报文类型的使用

#### 5.5 Traceroute：差错报文类型的使用

Traceroute的第一个作用就是故意设置TTL，来追踪去往目的地时沿途经过的路由器；

Traceroute还有一个作用是故意设置不分片，从而确定路径的MTU。

### 6 网关与路由器

#### 6.1 网关与路由器

网关往往是一个路由器，是一个三层转发设备，即把MAC头和IP头都取下来，根据里面的内容，看看接下来把包往哪里转发设备；

路由器是一台设备，它有五个网口或网卡，相当于五只手，分别连着五个局域网；每只手的IP地址都和局域网的IP地址由相同的网段，每只手都是它握住的那个局域网的网关。

#### 6.2 静态路由与动态路由

静态路由其实就是路由路上，配置一条一条的规则。

#### 6.3 转发网关与NAT网关

不改变IP地址的网关称之为转发网关，改变IP地址的网关成为NAT网关；NAT网关会改变IP地址，可以理解为国际IP和国内IP的转换；不管经过哪种网关，MAC头都要改变，因为在某一局域网网内，MAC地址是身份证，但是对于不同的局域网，只能通过IP 地址进行定位。

### 7 路由协议

#### 7.1 静态路由

设置路由表，包括以下三个内容：

①目的网络

②出口设备

③下一跳网关

#### 7.2 动态路由算法

距离矢量路由算法，基于此的BGP算法，一般应用于外网；

链路状态路由算法，基于此的OSPF算法，一般应用于网络内部。